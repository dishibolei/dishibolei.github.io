<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="安全,HTTPS,SSL证书," />





  <link rel="alternate" href="/atom.xml" title="萝卜的空间" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="导读： 本文主要讲在HTTP和HTTPS实际开发中有用和有意思的地方，希望读者能够有所启发。 主要包括：先讲HTTP协议，然后讲HTTPS协议，主要是HTTPS中加密流程和其中的策略，然后通过这个流程切入到常用的攻击手段、最后开始介绍SSL证书和说明为什么SSL证书验证可以有效的解决安全问题。 本文主要是简化的说明，和应用开发实际中真正接触到的知识。先偏理论，后续偏代码应用方面讲如何处理HTTP">
<meta name="keywords" content="安全,HTTPS,SSL证书">
<meta property="og:type" content="article">
<meta property="og:title" content="IOS应用安全-HTTP&#x2F;HTTPS网络安全(一)">
<meta property="og:url" content="https://dishibolei.github.io/2017/05/11/IOS应用安全-HTTP-HTTPS网络安全-一/index.html">
<meta property="og:site_name" content="萝卜的空间">
<meta property="og:description" content="导读： 本文主要讲在HTTP和HTTPS实际开发中有用和有意思的地方，希望读者能够有所启发。 主要包括：先讲HTTP协议，然后讲HTTPS协议，主要是HTTPS中加密流程和其中的策略，然后通过这个流程切入到常用的攻击手段、最后开始介绍SSL证书和说明为什么SSL证书验证可以有效的解决安全问题。 本文主要是简化的说明，和应用开发实际中真正接触到的知识。先偏理论，后续偏代码应用方面讲如何处理HTTP">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/safe_http_header_struct.png">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/safe_http_header1.png">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/safe_http_response_struct.jpg">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/safe_https_protocol.png">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/safe_https_message.jpg">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/safe_https_cer.png">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/safe_http_ssl_chain.png">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/safe_https_fake.png">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/charles_1.png">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/charles_2.png">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/charles_3.png">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/charles_4.jpg">
<meta property="og:image" content="https://github.com/dishibolei/img/raw/master/safe/http/charles_5.jpg">
<meta property="og:updated_time" content="2017-05-11T10:36:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="IOS应用安全-HTTP&#x2F;HTTPS网络安全(一)">
<meta name="twitter:description" content="导读： 本文主要讲在HTTP和HTTPS实际开发中有用和有意思的地方，希望读者能够有所启发。 主要包括：先讲HTTP协议，然后讲HTTPS协议，主要是HTTPS中加密流程和其中的策略，然后通过这个流程切入到常用的攻击手段、最后开始介绍SSL证书和说明为什么SSL证书验证可以有效的解决安全问题。 本文主要是简化的说明，和应用开发实际中真正接触到的知识。先偏理论，后续偏代码应用方面讲如何处理HTTP">
<meta name="twitter:image" content="https://github.com/dishibolei/img/raw/master/safe/http/safe_http_header_struct.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dishibolei.github.io/2017/05/11/IOS应用安全-HTTP-HTTPS网络安全-一/"/>





  <title>IOS应用安全-HTTP/HTTPS网络安全(一) | 萝卜的空间</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3d37ed280a5354742296ba32e7046ac8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">萝卜的空间</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">我的小博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://dishibolei.github.io/2017/05/11/IOS应用安全-HTTP-HTTPS网络安全-一/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="bolei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="萝卜的空间">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">IOS应用安全-HTTP/HTTPS网络安全(一)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-11T15:21:51+08:00">
                2017-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全/" itemprop="url" rel="index">
                    <span itemprop="name">安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>导读：</p>
<p>本文主要讲在HTTP和HTTPS实际开发中有用和有意思的地方，希望读者能够有所启发。</p>
<p>主要包括：先讲HTTP协议，然后讲HTTPS协议，主要是HTTPS中加密流程和其中的策略，然后通过这个流程切入到常用的攻击手段、最后开始介绍SSL证书和说明为什么SSL证书验证可以有效的解决安全问题。</p>
<p>本文主要是简化的说明，和应用开发实际中真正接触到的知识。先偏理论，后续偏代码应用方面讲如何处理HTTPS的安全问题。</p>
</blockquote>
<a id="more"></a>
<h1 id="HTTP简介"><a href="#HTTP简介" class="headerlink" title="HTTP简介"></a>HTTP简介</h1><p>具体说明不想过多讨论，可以参考后面的参考文献，只写我觉得有意思和实际中可以参考的地方。</p>
<ol>
<li><p>HTTP协议构建于TCP之上。意味着http是可靠的数据传输。所以不用担心丢包和乱序的问题。</p>
</li>
<li><p>HTTP协议是基于请求和响应的协议。与之对比MQTT协议是基于订阅的协议。</p>
<p> 比如我想要一个资源的种子，如果知道哪个老司机有，我直接问他，他有就给我，没有也告诉我没有。这种模式就是请求和响应，好处是一对一，可以<strong>准确完整的按照自己的需求拿到需要的数据</strong>，但是坏处是消息会滞后，我想知道老司机后面是不是有资源了，我就只能一遍遍重复的问，直到拿到想要的结果为止（循环延迟请求，之前专门写个looperRequest就是为了解决这种问题）。</p>
<p> 另外一种方案，我发布消息到一个论坛，然后留下邮箱，求好人一生平安。然后很多好人有资源就发给我，这样也能拿到数据。这种模式就是订阅模式，好处是可以一对多，可以<strong>快速实时拿到数据</strong>。但是<strong>坏处是：需要长链接</strong>，且推送消息时不清楚客户端的状态，推送的东西不一定需要，比如这个种子可能我已经有了，再发给我就浪费大家的流量了。</p>
<p> 总结下。利用请求应答的模式，可以快速的和服务端同步数据，保证当前请求数据的有效性，有时候我们也叫拉（pull）数据。订阅模块可以快速的更新需要保证实时性的数据，比如聊天数据，交易结果，账户异常，有时候我们也叫推送（push）数据。</p>
<p> 这两种方案是和服务端常用的两种交互方案，有些交互可以考虑两者结合的方式解决。比如之前项目中解决聊天数据的实时有效性，就采用后端推送当前有新消息或其他状态信息，前端收到状态信息后，主动拉取消息到本地，既能保证能够快速更新消息或状态，又能通过本地的状态，按照需求拉取需要的消息。</p>
<p> 推/拉这种设计思路也可以用于应用间的数据同步，应用于模块间数据通信来进行模块解耦等。现在的项目工程模块化设计方案也借鉴了这两种思想。</p>
</li>
<li><p>URL。URL定义了一个资源的地址。大部分格式如下</p>
<p> <code>protocol :// hostname[:port] / abs_path / [;parameters][?query]#fragment</code></p>
<p> 详细说明<a href="http://baike.baidu.com/link?url=9uGFzaUuMRGf4Nn-ucSUqrSYI4vwDls4jVrxZ_7iHZqCnp7FJJTW1ZGp8lzyJ28m9uweSaN6CREycgIObuspD7UQeq1_WlQjnbEzvpjBBK7" target="_blank" rel="external">参考</a></p>
<p> 其中query用“&amp;”符号隔开，每个参数的名和值用“=”符号隔开。例如：<code>http://www.joes.com/inventory-check.cgi?item=12731&amp;color=blue</code>。唯一需要注意的是，URL里面不容许有非ASCII字符（常见的就是汉字），也不容许有保留字符比如：<code>!*&#39;\&quot;();:@&amp;=+$,/?%#[]%</code>,所以通常拼接请求时（GET），需要对传进来的参数做<strong>一次URLEncode</strong>操作。</p>
<p> <strong>可以参考这个做私有协议跳转，比如push消息协议，模块跳转协议，外部跳转协议等。</strong></p>
</li>
</ol>
<ol>
<li><p>http请求由三部分组成，分别是：请求行、消息报头、请求正文.详细的建议使用charles抓一个请求看下就知道了。</p>
<p><img src="https://github.com/dishibolei/img/raw/master/safe/http/safe_http_header_struct.png" alt=""> </p>
<p>注：来源于<a href="http://www.cnblogs.com/ranyonsue/p/5984001.html" target="_blank" rel="external">http://www.cnblogs.com/ranyonsue/p/5984001.html</a>.</p>
<p><img src="https://github.com/dishibolei/img/raw/master/safe/http/safe_http_header1.png" alt=""></p>
<p>重要的几个请求报头字段：</p>
<ul>
<li>Accept: 指定客户端接受的消息类型（通常没人使用,因为客户端大量使用json做数据解析）</li>
<li>Host:请求报头域主要用于指定被请求资源的Internet主机和端口号，它通常从HTTP URL中提取出来的</li>
<li>User-Agent:用于附加操作系统名称和浏览器版本，通常给H5使用的，UA很容易被修改，项目中有遇到修改UA导致H5页面识别不出来当前操作系统和版本的问题，遇到这种可以查下UA被谁篡改了。</li>
<li>Referer:用于标示请求来源，一般用于防盗链，这个实际中也遇到过。</li>
</ul>
</li>
<li><p>http的响应一般由三个部分组成，分别是:状态行，消息报头，响应正文。</p>
<p> <img src="https://github.com/dishibolei/img/raw/master/safe/http/safe_http_response_struct.jpg" alt=""><br> 注：来源于<a href="http://www.cnblogs.com/ranyonsue/p/5984001.html" target="_blank" rel="external">http://www.cnblogs.com/ranyonsue/p/5984001.html</a>.</p>
<p> 重要的几个消息报头</p>
<ul>
<li>Content-Type 正文媒体类型和编码格式，比如：<code>Content-Type:text/html;charset=ISO-8859-1</code>.Content-Type这个字段被AFNetworking框架用于决定用什么解析器，注意后端不要配置错了。charset被用于AFNetworking字符解码，也应该前后端配置正确。这个配置不正确是经常联调不过的原因。 具体实现参考<code>AFURLResonseSerialization.m</code>。</li>
<li>Content-Length 用于表示正文长度，下载长资源时，需要使用这个字段来计算进度，也可以用这个字段推算下载流量。</li>
<li>Content-Encoding 通常用于记录压缩方法，比如：<code>gzip</code>。</li>
</ul>
</li>
<li><p>GET和POST的方法。HTTP有定义了几种常用的方法，不过通常前端只和这两个打交道。这两个区别：</p>
<ul>
<li>通常认为get是获取消息，不改变数据，post是用来改变数据，不过实际中，并不是那么明确。</li>
<li>get参数是附在URL链接上的，参数拼接前需要做URLEncode，post是附在请求正文里的,格式为key=value，使用&amp;分割，所以对传入数据也要做URLEncode，拼接后和头部用回车换行隔开。</li>
<li>get的URL长度有一定限制，不过也取决于系统支持，具体长度需要实际调研，ie的限制为2083字节，post理论上不存在长度限制。</li>
<li>安全性，post相对安全，get相对不安全。不过post属于防君子不防小人的那种，实际没有什么安全可言。<br>所以综合来说，如果没有技术洁癖，建议都用post处理。</li>
</ul>
</li>
<li><p>上传图片等文本资源。上传资源一般是post协议，但是通常post是用于传送文本的，如何传图片等资源呢？就需要<code>multipart</code>协议了。</p>
<p> mutipart和普通的post有两点不同：请求头，请求报文。其中关键字是<code>boundary</code>这个属性。</p>
<ul>
<li>请求头： 必须包含<code>content-Type</code>，且值为：<code>multipart/form-data;boundary=${bond}</code>,其中${bound}为具体分割符，在AFNetworking中，如果不指定是<code>Boundary+${random}</code>。</li>
<li><p>请求体:内容不再是用name=value的形式，而是使用上面的boundary进行分割的一段一段的结构体。具体示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">   </div><div class="line">POST /btoa/work/common/uploadImage HTTP/1.1</div><div class="line">Host: www.example.com</div><div class="line">Content-Type: multipart/form-data; boundary=Boundary+49F77F66A65EEA58</div><div class="line">Cookie: BIGipServerPOOL_PACLOUD_STGR2016080900646=1274288556.52384.0000; FF_SESSION2_ID=Sf503bee3691b4a31a53c6e3c5ae1c1f00912e8</div><div class="line">Connection: keep-alive</div><div class="line">Accept: */*</div><div class="line">User-Agent: FFProject/2.0.0 (iPhone; iOS 10.3.1; Scale/3.00)</div><div class="line">Accept-Language: zh-Hans-CN;q=1, th-TH;q=0.9</div><div class="line">Content-Length: 418864</div><div class="line">Accept-Encoding: gzip, deflate</div><div class="line"></div><div class="line">--Boundary+49F77F66A65EEA58</div><div class="line">Content-Disposition: form-data; name=&quot;ffAppID&quot;</div><div class="line"></div><div class="line">10004</div><div class="line">--Boundary+49F77F66A65EEA58</div><div class="line">Content-Disposition: form-data; name=&quot;imageSeq&quot;</div><div class="line"></div><div class="line">1</div><div class="line">--Boundary+49F77F66A65EEA58</div><div class="line">Content-Disposition: form-data; name=&quot;imageType&quot;</div><div class="line"></div><div class="line">5</div><div class="line">--Boundary+49F77F66A65EEA58</div><div class="line">Content-Disposition: form-data; name=&quot;image&quot;; filename=&quot;xxxx.jpg&quot;</div><div class="line">Content-Type: image/jpeg</div><div class="line"></div><div class="line">***image hex data***</div><div class="line"></div><div class="line">--Boundary+49F77F66A65EEA58--</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<p>   看到上面的例子可以知道，有几个参数是必须的，<code>name、filename、Content-Type、具体资源数据</code> ，对应的AF接口：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (void)appendPartWithFileData:(NSData *)data</div><div class="line">                      name:(NSString *)name</div><div class="line">                  fileName:(NSString *)fileName</div><div class="line">                  mimeType:(NSString *)mimeType;</div></pre></td></tr></table></figure>
</code></pre><h1 id="HTTPS简介"><a href="#HTTPS简介" class="headerlink" title="HTTPS简介"></a>HTTPS简介</h1><p>苹果ATS政策出来之前，后端极少使用HTTPS协议，而是使用HTTP协议+自定义的安全数据加密策略来保证安全性。这是因为虽然HTTPS更安全，但是也更加耗费性能。如今苹果强推HTTPS（有说法是苹果可能会全面禁止HTTP的使用），使得HTTPS大范围使用，并且使用HTTPS作为安全扫描项，被安全机构接纳。但是如果不正确的使用HTTPS，还是会带来安全风险。</p>
<h2 id="SSL-TLS简介"><a href="#SSL-TLS简介" class="headerlink" title="SSL/TLS简介"></a>SSL/TLS简介</h2><p>HTTPS的关键字就是SSL（TLS）。和HTTP唯一的不同就是加入了SSL（TLS）协议，这一层在TCP之上，负责保证安全连接和数据传输安全。</p>
<p><img src="https://github.com/dishibolei/img/raw/master/safe/http/safe_https_protocol.png" alt=""></p>
<p>注：来自 <a href="https://www.zybuluo.com/qidiandasheng/note/713956" target="_blank" rel="external">深入解析HTTPS</a> </p>
<p>SSL实际上是一套加密通信机制。SSL和TLS两者的协议基本一致，区别简单可以理解是TLS是SSL的升级版本。<strong>但是使用SSL所有协议版本都不再安全。请勿使用SSL协议</strong> 具体可以参考<a href="http://kb.cnblogs.com/page/197396/" target="_blank" rel="external">SSL与TLS的区别以及介绍</a></p>
<p>ios加入了ATS限制，强制原来HTTP必须使用HTTPS传输，也强制要求服务器必须使用TLS v1.2版本以上。所以简化为：</p>
<p><strong>要使用支持TLS1.2及以上协议的HTTPS传输数据</strong></p>
<p>PS：后面如无特殊说明，不再区分TLS和SSL，统一称为SSL</p>
<h2 id="HTTPS原理"><a href="#HTTPS原理" class="headerlink" title="HTTPS原理"></a>HTTPS原理</h2><p>建议看下<a href="http://blog.csdn.net/muzhengjun/article/details/53379593" target="_blank" rel="external">浅析HTTPS中间人攻击与证书校验</a>和<a href="http://www.open-open.com/lib/view/open1411260089562.html" target="_blank" rel="external">阮一峰：图解SSL/TLS协议</a>和<a href="http://www.cnblogs.com/LittleHann/p/3733469.html?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">SSL、TLS协议格式入门学习 - .Little Hann</a></p>
<p>下面是协议流程图：</p>
<p><img src="https://github.com/dishibolei/img/raw/master/safe/http/safe_https_message.jpg" alt=""></p>
<p>注：来自<a href="http://blog.csdn.net/muzhengjun/article/details/53379593" target="_blank" rel="external">http://blog.csdn.net/muzhengjun/article/details/53379593</a></p>
<p>简单描述：</p>
<ol>
<li>TCP握手</li>
<li>SSL握手，握手成功就开始传输，失败就断开链接</li>
<li>数据传输</li>
</ol>
<p>下面也是只讲一些有意思的点和注意的地方。</p>
<h3 id="HTTPS加密流程"><a href="#HTTPS加密流程" class="headerlink" title="HTTPS加密流程"></a>HTTPS加密流程</h3><p>整个加密的流程，体现了一个非常安全的信息加密的方案。 简化的流程如下：</p>
<ol>
<li>客户发送一个随机数给服务端，random-c（明文）</li>
<li>服务端发送自己SSL证书给客户端。发送服务端随机数，random-s（明文）</li>
<li><strong>客户端验证SSL证书有效性，如果判定有效，生成一个随机数random-p,然后使用证书中的公钥进行非对称加密，发送给服务端。</strong> （这一步是整个安全环节最重要也是最薄弱的环节）</li>
<li>服务端拿到加密后的秘钥，通过私钥解密，得到random-p ，将random-c、random-s、random-p三个随机数做因子，两端都按照一定算法生成会话对称秘钥secret_key。</li>
<li>客户端计算之前的握手消息（除了Change Cipher Spec外）的Hash值，利用secret_key做对称加密后发给服务端。</li>
<li>服务端拿到后，利用secret_key解密，然后利用同样的算法计算之前的握手消息的Hash值，如果能解密成功，且验证Hash值正确则说明客户端的加密算法和秘钥没问题。</li>
<li>服务端再计算之前的握手消息的Hash值，利用secret_key做对称加密后发给客户端，客户端如果能够解密出来，且与自己计算的Hash值相同，则最后链接正式建立成功。</li>
</ol>
<p>先简单说明几个概念，详细的会专门抽出来分享：</p>
<ol>
<li>对称加密：双方使用的秘钥是相同的，使用同一个秘钥进行加解密。</li>
<li>非对称加密：加密使用公钥加密，解密使用私钥加密。或者私钥加密，使用公钥解密。但是公钥和私钥是不同的。公钥是公开的，可以被第三方拿到而不会引起任何安全问题，因为通过公钥是无法得到私钥的，也没办法解密使用公钥加密的数据。</li>
<li>散列（hash）：散列变换是指把文件内容通过某种公开的算法，变成固定长度的值（散列值），这个过程可以使用密钥也可以不使用。这种散列变换是不可逆的，也就是说不能从散列值变成原文。好的散列算法是一对一的，不同的原文生成的一定是不同的散列。</li>
</ol>
<p>这其中使用的加密策略：</p>
<ol>
<li>传输数据应该加密，整个加密过程使用了两种加密方案，一种对称加密，一种非对称加密。</li>
<li>传输数据使用了对称加密，而秘钥生成中使用了非对称加密。</li>
<li>使用了散列算法（hash）来做数据验证。</li>
</ol>
<p>回答这里面常见的几个问题：</p>
<ol>
<li><p>为什么又要用非对称加密，又要用对称加密，只使用一个不可以么？</p>
<blockquote>
<blockquote>
<p>不能只是用对称加密，因为对称加密，两个使用的秘钥是一致的，有一端的秘钥泄露了，两端的通信就不再安全了，尤其是客户端的对称秘钥非常容易泄露，拿到秘钥后，整个系统就不安全了。</p>
<p>也不只用非对称加密，主要是因为性能，非对称加密相对于对称加密，计算时间要长非常多，对于性能要求很高的场景，会明显降低性能。<a href="http://blog.csdn.net/yore_/article/details/52733994" target="_blank" rel="external">RSA算法和AES算法性能测试</a></p>
<p>所以设计者结合了两种方案。两端通过非对称加密协商秘钥，攻击者因为拿不到私钥，是无法解开通信秘钥的。一旦协商成功，通过对称加密又解决了性能问题。</p>
</blockquote>
</blockquote>
</li>
<li><p>为什么使用三个随机数</p>
<blockquote>
<blockquote>
<p>还是为了进一步加强安全，客户端或者服务端生成的随机数可能是伪随机的，有可能被攻击者猜出，但是如果三个伪随机的数一起使用就大大加强了随机性，这样攻击者就很难破解了。</p>
</blockquote>
</blockquote>
</li>
<li><p>为什么最后要做hash验证</p>
<blockquote>
<blockquote>
<p>为了保证两端通信中的数据不会做篡改，由于HASH算法，可以保证唯一性，所以如果中间消息被人篡改，就可以断开链接。</p>
</blockquote>
</blockquote>
</li>
</ol>
<p><strong>所以下面是非常建议的一个信道传输加密的方案</strong>：</p>
<ol>
<li>使用随机数做对称加密秘钥，将对称加密秘钥使用公钥进行非对称加密传给后端。这样因为秘钥随机，所以即使客户端被破解，也拿不到任何对称秘钥。而公钥进行动态获取，避免私钥泄露带来的问题。</li>
<li>使用非对称加密秘钥，可以保证网络数据即使劫持，因为没有私钥，也解不出来对应的加密秘钥，所以加密的隐私数据也是安全的</li>
<li>两者结合，可以保证一定的性能要求。</li>
<li>对数据进行加签（加盐+hash算法），保证中间的数据不会篡改。</li>
</ol>
<p>ps:用户的密码，因为保密性要求更高。建议的算法是做HMAC哈希做脱敏，然后使用非对称加密给后端。</p>
<h1 id="常用的网络传输攻击手段"><a href="#常用的网络传输攻击手段" class="headerlink" title="常用的网络传输攻击手段"></a>常用的网络传输攻击手段</h1><p>先思考下，刚才的通信链路有三个参与者：</p>
<ol>
<li>客户端</li>
<li>传输信道</li>
<li>服务端</li>
</ol>
<p>如果新加入一个攻击者，他想要窃取用户的隐私数据，他该怎么做？常见的做法：</p>
<ol>
<li>攻击客户端。对于IOS系统来说，非越狱手机，由于权限问题，几乎无法攻击（之前<a href="https://www.baidu.com/link?url=gtxpH2omxSt5NpX-5RmuUYCFmWA-C49q7fQPWnJMO7wtUCpSIXTuEoYZ4B94QDc9Po6lrX7SzKvtEMH8R46XGfGKtnx42FxROp5zbVZ6Irm&amp;wd=&amp;eqid=aa656a8100001a250000000659127d0b" target="_blank" rel="external">XcodeGhost</a>真的是很nb的攻击思路）。对于越狱手机，通过HOOK API，然后重新打包应用，诱导用户下载。或者劫持系统的输入框等常用控件。相关的以后整理输出。但是从移动APP来说，直接攻击APP带来的危害和利用性很低，通常只会泄露很少的用户信息。大多是利用来薅羊毛的。</li>
<li>攻击传输信道。攻击手段有中间人攻击，DNS劫持等。</li>
<li>攻击服务端。也非常难做到。一般是模板注入，撞库等。</li>
</ol>
<p>这里面其实最容易的就是攻击传输信道。排除技术术语，手段有：</p>
<ol>
<li>伪装成正常的客户端攻击服务端</li>
<li>伪装成正常的服务端，劫持客户端数据</li>
<li>监听修改信道数据</li>
</ol>
<p>这几种怎么解决？</p>
<p>问：如何处理伪装成正常的客户端攻击服务端</p>
<blockquote>
<p>在认为客户端app本身是无法攻破的前提下：</p>
<ol>
<li>请求中一定加入签名策略。攻击者不知道签名策略是无法仿造请求的，也防止劫持者修改。发现签名不对，服务端认为是假的客户端。</li>
<li>请求中一定加入请求防重放策略。服务端发现是之前的请求，重复发送过来的（可能只有签名不一致），应该忽略</li>
<li>加入风险控制策略。比如异地登陆，同一设备ip反复请求，一些金融类app也会加入公安部认证的风控系统，防止一些有金融犯罪前科的用户请求。后端使用风控策略，禁止用户登录，或者强制要求用户再次身份认证，比如手机验证码认证。</li>
</ol>
</blockquote>
<p>问：如何处理监听修改信道数据<br>&gt;</p>
<blockquote>
<ol>
<li>请求关键数据做加密，加密方案建议使用上面提到的加密方案。这样即使被监听，拿到数据也无法处理</li>
<li>加入签名，防止数据篡改。</li>
</ol>
</blockquote>
<p>问：如何处理伪装成正常的服务端，劫持客户端数据</p>
<blockquote>
<p>这一种方式是目前攻击最常见且有效的手段。使用http的时候，因为没有任何认证措施，通过ARP或者DNS劫持，非常容易将网址定向到其他攻击者的地址，攻击者可以做劫持和修改相关数据。所以HTTP现在已经被各大平台所抛弃。很多开发遇到的访问一个h5页面，被运营商强插入广告就是这么做的。解决办法就是正确的使用HTTPS</p>
</blockquote>
<p>HTTPS，很大一部分作用就是解决上述问题。也就是通过SSL握手，校验服务端证书，达到验证是否是伪装的服务端的目的。HTTPS握手阶段算法原理都是安全的，只有验证身份这一步有漏洞，即只要想办法让客户端认为证书是可信的，证书里面的公钥就是生成者的公钥，自然就有相对应的私钥，后面非对称加密生成的对称秘钥就可以被截取到，造成整个链路不安全。如何攻击这个策略，行业上主要称为<strong>中间人攻击</strong>。</p>
<h1 id="SSL证书"><a href="#SSL证书" class="headerlink" title="SSL证书"></a>SSL证书</h1><p>可以说<strong>验证SSL证书是整个HTTPS的关键</strong>，如果这一步出问题，后面的就没有任何安全可言。而对于我们前端开发来说，SSL证书也是最需要关注的地方。</p>
<p>这里讲两个问题。SSL证书是什么？为什么通过SSL证书可以防止攻击者伪装成服务端。</p>
<h2 id="SSL证书是什么"><a href="#SSL证书是什么" class="headerlink" title="SSL证书是什么"></a>SSL证书是什么</h2><p>SSL证书是一个文件。里面的内容包括：用户的信息、用户的公钥、还有CA中心对该证书里面的信息的签名。<br>一个证书的实例：</p>
<p>打开safari，打开百度，<code>https://www.baidu.com</code>,在地址栏点击锁按钮，然后选显示证书。</p>
<p><img src="https://github.com/dishibolei/img/raw/master/safe/http/safe_https_cer.png" alt=""></p>
<p>里面的内容只有几个需要关注的：</p>
<ol>
<li>常用名称：<code>baidu.com</code> 。客户端或浏览器，根据常用名称和访问的域名做匹配，访问的域名和证书的域名不一致，就会拒绝访问，达到<strong>防止域名劫持的目的</strong>。这个信息可以被伪造。</li>
<li>公共密钥：SSL握手生成的第二段随机串是通过这个公钥来加密的。这个信息可以被伪造，但是伪造没有异议。（想知道为啥的可以看看证书生成的步骤。）</li>
<li>签名：是对整个证书内容做hash之后，使用颁发机构的<strong>私钥</strong>加密的值。这个信息可以被伪造，但是伪造没有异议。</li>
<li>签名者信息：颁发机构的信息，由于验证上一级的证书信息。这个信息可以被伪造。</li>
<li>证书有效期。这个信息可以被伪造。</li>
</ol>
<p>可以看到在百度这个证书上面还有两个证书，这是因为百度这个证书是有GS这个机构的二级机构颁发的，而GS这个二级机构是由GS的CA根证书颁发的。</p>
<p>也就是证书有证书链的概念，即这个证书可能是上一层机构颁发的，从CA根证书开始-&gt;二级CA证书-&gt;三级CA证书-&gt;…。</p>
<p><img src="https://github.com/dishibolei/img/raw/master/safe/http/safe_http_ssl_chain.png" alt=""></p>
<p>注：来自<a href="http://blog.csdn.net/shen_guo/article/details/49891459" target="_blank" rel="external">SSL 之证书链</a></p>
<h2 id="SSL证书如何验证的"><a href="#SSL证书如何验证的" class="headerlink" title="SSL证书如何验证的"></a>SSL证书如何验证的</h2><p>推荐这篇文章，是目前看到讲的最清楚。<a href="http://www.2cto.com/article/201607/523509.html" target="_blank" rel="external">浅析HTTPS中间人攻击与证书校验</a></p>
<p>根据HTTPS协议，服务端会在握手的时候将证书传送给客户单，<strong>而且是将整个证书链发过来</strong>。</p>
<p>通常的验证传过来的证书是否有效的步骤为：</p>
<ol>
<li>验证证书的常用名称是否是访问的域名，是否在有效期内。（域名校验+有效期校验）</li>
<li>计算这个证书内容的散列值得到MD5-a，然后用颁发机构的公钥解密这个证书的签名得到MD5-b，比较两个值是否相同，如果相同说明这个证书确实是上个颁发机构颁发的。</li>
<li>重复上面的操作，直到验证到CA根证书。CA证书是自签名的，也就是签名是用自己的私钥签名的。<br>可是CA根证书签名是用自己的私钥做签名，怎么去验证这个证书是否正确呢？</li>
</ol>
<p>最终上面的问题简化为：</p>
<h2 id="如何验证CA根证书有效性"><a href="#如何验证CA根证书有效性" class="headerlink" title="如何验证CA根证书有效性"></a>如何验证CA根证书有效性</h2><p>最终层层拨茧，HTTPS的安全性关键钥匙就在这一章了。</p>
<p>CA根证书有两种生成方式：</p>
<ol>
<li>由可信的颁发机构办法</li>
<li>本地自己生成</li>
</ol>
<p>对于第一种，因为可信的颁发机构很少，这些机构的CA证书会默认保存在浏览器里或者手机操作系统里，这种证书的有效性会由办法机构保证。不过这种证书需要向颁发机构申请，颁发机构会花时间去进行公司域名身份等信息验证，所以花费也不少。</p>
<p>对于第二种，本地生成的证书（后面会附录如何生成自签名证书），证书常用的信息都可以生成，可以认为证书信息内容都不可靠，尤其是证书中的域名。使用自制证书在浏览器会弹出警告不可信，用户可以手动添加到信任列表里，之后可信了才可以访问，12306之前让下载证书导入，就是这个原因。在应用APP里，如果使用默认配置，会拒绝，返回SSL验证失败。</p>
<p>这时候两种办法：</p>
<p>第一种</p>
<blockquote>
<p>安装描述文件到系统里。在安装charles过程中，其中一步就是打开一个网址，在弹出安装的时候，安装这个证书，也可以把这个证书下载到云盘里，然后打开。这个过程需要用户手动授权。</p>
</blockquote>
<p>第二种</p>
<blockquote>
<p>把这个根证书，埋入APP里,然后设置为证书锚点（可以设置多个），然后在SSL握手需要验证证书的时候，这样系统会认为这个证书是有效的。这个方案也是很多自签名证书进行校验的方法。</p>
</blockquote>
<h2 id="中间人攻击"><a href="#中间人攻击" class="headerlink" title="中间人攻击"></a>中间人攻击</h2><p>中间人攻击是最常见的攻击HTTPS手段。</p>
<p>建议看这篇文章：<a href="http://oncenote.com/2015/09/16/Security-2-HTTPS2/" target="_blank" rel="external">iOS安全系列之二：HTTPS进阶</a></p>
<p>看到上面的验证手段，其实关键就在于如何信任CA根证书上面。攻击者就是想尽一切办法让客户端安装他自己的CA证书到你的手机里。</p>
<p>如果手机没有越狱，一定会引诱你去安装这个证书，并且手动设为可信。一旦信任，在访问服务器的时候，攻击者通过代理劫持，通过这个信任的CA证书，生成对应的域名的证书。最终因为域名可信，有效期可信，证书可信所以整个HTTPS建立成功，攻击者拿到相关的数据。</p>
<p>使用charles抓包的整个过程，其实就是中间人攻击的过程。</p>
<p>下面是charles开启SSL代理后，访问新浪弹出的证书信息：</p>
<p><img src="https://github.com/dishibolei/img/raw/master/safe/http/safe_https_fake.png" alt=""></p>
<p>提示：<strong>对于用户来说，不要信任任何CA证书，不安装任何描述文件是最安全的方法。</strong>比如安装飙车软件，让你信任一个证书。比如链接外部wifi，提示你安装证书才可以链接。比如翻墙设置代理，提示你安装信任证书。描述文件在通用-&gt;描述文件与设备管理中找到。</p>
<h2 id="校验证书的姿势"><a href="#校验证书的姿势" class="headerlink" title="校验证书的姿势"></a>校验证书的姿势</h2><p>校验证书有两种方案：</p>
<blockquote>
<blockquote>
<p>弱校验</p>
</blockquote>
</blockquote>
<p>对于服务端证书，校验下面的case。</p>
<ol>
<li>校验证书的域名</li>
<li>校验证书的有效期</li>
<li>校验证书链和证书的有效性</li>
</ol>
<p>保证这三者有效，已经可以解决大部分的攻击了，对于大部分APP已经试用。唯一的风险就是中间人攻击，被安装CA证书之后，存在着风险，但是攻击难度已经大大增加了。<em>AFNetworking框架默认采用的就是这个策略</em>。</p>
<blockquote>
<blockquote>
<p>强校验</p>
</blockquote>
</blockquote>
<p>将证书放入APP中作为证书锚点。在上面的基础上在验证证书。这样可以完全保证服务端的证书是真正需要的证书，从而真正解决中间人攻击。</p>
<p>下面主要讲下强校验面临的坑，各位开发一定要注意。</p>
<h2 id="证书强校验的坑"><a href="#证书强校验的坑" class="headerlink" title="证书强校验的坑"></a>证书强校验的坑</h2><p>证书是有有效期的，尤其是非自制证书，通常都在三年以内，自制证书一般没有限制（所以很多资料根本不谈这个问题）。一旦有效期过了，服务端就需要更换证书,但是由于APP存在发版的情况，老的APP由于所有链接失败，导致老APP任何请求都失效，然后无法通知用户更新，老用户也不知道因为什么访问失败。（这些都是血的教训啊）</p>
<p>有几个建议的地方：</p>
<ol>
<li>尽量埋CA证书，因为CA证书的有效期要长，有足够的时间准备。</li>
<li>有些通道不要使用证书强校验，比如检查升级，一些热修复策略，尽量使用自有的安全逻辑保证安全。</li>
</ol>
<p>上面的是尽量降低风险，该出问题的时候还是会出，有一些不完美的方案大家可以参考下：</p>
<p>方案1：动态更新证书。</p>
<blockquote>
<blockquote>
<p>在APP中放入RSA公钥，应用启动的时候，证书信息通过私钥加密，发送给前端保存，前端把这个新证书和埋入的证书一起做锚点，进行验证。这样可以保证老APP可以使用一段时间。缺点是这个下发的机制要尽量安全可靠，有可能被攻击者利用，所以方案复杂一些。</p>
</blockquote>
</blockquote>
<p>方案2：只验证证书的公钥</p>
<blockquote>
<blockquote>
<p>只使用证书的公钥进行验证，因为更换证书，一般是通过.csr文件生成crt证书文件的（也就是证书文件），在.csr文件没变的情况下，生成的证书的公钥是一致的，也就即使服务端更换了证书，只要公钥不变，依然可以通过验证。而中间人是没法通过公钥反推出私钥的，即使知道了公钥也没办法解密。所以验证公钥也是相对安全的。缺点是如果新的证书换了公钥还是出问题。我遇到的case就是需要更换私钥和证书算法，公钥也不一样了。</p>
</blockquote>
</blockquote>
<p>其他不太靠谱的方案：</p>
<p>方案3：</p>
<blockquote>
<blockquote>
<p>在弱校验的基础上，加上验证颁发机构。只要读到颁发机构是可信的，证书就认为是有效的。可以解决第三方抓包工具的抓包问题，因为第三方抓包工具，一般使用自己的颁发机构，和实际的颁发机构不一致。缺点是，证书是可以完全伪造的，包括颁发结构的名字，有效期等等都可以伪造。</p>
</blockquote>
</blockquote>
<p>方案4：</p>
<blockquote>
<blockquote>
<p>信任无效的证书。 信任无效的证书，但是做本地证书校验，在失效的一段时间内，后端先不部署新证书，在新版本里面提前埋入新证书，在几个版本后再上线新的证书。优点是简单，不怕哪天忘了更换证书导致出问题。缺点是信任失效的证书，如果真的有需求要强制更换证书，就没办法处理。</p>
</blockquote>
</blockquote>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录:"></a>附录:</h1><h2 id="如何生成自签名证书"><a href="#如何生成自签名证书" class="headerlink" title="如何生成自签名证书"></a>如何生成自签名证书</h2><p>参考 <a href="https://www.zybuluo.com/qidiandasheng/note/713956" target="_blank" rel="external">深入解析HTTPS</a>和<a href="https://my.oschina.net/wayhk/blog/491958?p=1" target="_blank" rel="external">利用OpenSSL创建自签名的SSL证书</a> 和 <a href="http://blog.csdn.net/sdcxyz/article/details/47220129" target="_blank" rel="external">自签名证书和私有CA签名的证书的区别 创建自签名证书 创建私有CA 证书类型 证书扩展名</a></p>
<ol>
<li><p>生成私钥</p>
<p> <code>openssl genrsa -out ca.key 2048</code> </p>
</li>
<li><p>利用私钥创建根证书</p>
<p><code>openssl req -new -x509 -days 36500 -key ca.key -out ca.crt</code></p>
<p>弹出的对话框按照提示填写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">  Country Name (2 letter code) [AU]:CN</div><div class="line">State or Province Name (full name) [Some-State]:Guangdong</div><div class="line">Locality Name (eg, city) []:Shenzhen</div><div class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:BL.inc</div><div class="line">Organizational Unit Name (eg, section) []:</div><div class="line">Common Name (e.g. server FQDN or YOUR name) []:BL</div><div class="line">Email Address []:</div></pre></td></tr></table></figure>
</li>
<li><p>创建SSL证书私钥</p>
<p><code>openssl genrsa -out server.key 2048</code></p>
</li>
<li><p>使用刚才的私钥签名</p>
<p><code>openssl req -new -key server.key -out server.csr</code></p>
<p>弹出的对话框按照提示填写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">  Country Name (2 letter code) [AU]:CN</div><div class="line">State or Province Name (full name) [Some-State]:Guangdong</div><div class="line">Locality Name (eg, city) []:Shenzhen</div><div class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:BL.inc</div><div class="line">Organizational Unit Name (eg, section) []:</div><div class="line">Common Name (e.g. server FQDN or YOUR name) []:*.sina.com.cn</div><div class="line">Email Address []:</div><div class="line"></div><div class="line">Please enter the following &apos;extra&apos; attributes</div><div class="line">to be sent with your certificate request</div><div class="line">A challenge password []:1111</div><div class="line">An optional company name []:</div></pre></td></tr></table></figure>
</li>
</ol>
<p>   注意，这里的Common Name 应该和实际的域名匹配。而且生成的.csr这个文件最好长期保留，下次过期的时候，建议直接用这个文件做签名。如果是向CA颁发机构申请，提交的文件也是这个文件。</p>
<ol>
<li><p>对上一步的csr使用CA进行签名生成证书</p>
<p><code>openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out server.crt</code>   </p>
</li>
<li><p>如果有必要可以重复上面必要步骤，使用上一步的证书的.crt和.key继续签名下一级证书。</p>
<p>一些常用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">openssl rsa -noout -text -in server.key 查看私钥信息</div><div class="line">openssl req -noout -text -in server.csr 查看签名请求信息</div><div class="line">openssl x509 -noout -text -in ca.crt 查看证书信息</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="MAC下使用Charles抓包"><a href="#MAC下使用Charles抓包" class="headerlink" title="MAC下使用Charles抓包"></a>MAC下使用Charles抓包</h2><p>参考 <a href="https://www.zybuluo.com/qidiandasheng/note/713956" target="_blank" rel="external">深入解析HTTPS</a> 和 <a href="http://oncenote.com/2015/09/16/Security-2-HTTPS2/" target="_blank" rel="external">iOS安全系列之二：HTTPS进阶</a></p>
<ul>
<li><p>安装Charles CA根证书 </p>
<p>点击Help-&gt;SSL Proxying-&gt;Install Charles Root Certification …，会弹出如下提示，链接代理，手机浏览器输入chls.pro/ssl，就可以安装根证书了。 </p>
<p><img src="https://github.com/dishibolei/img/raw/master/safe/http/charles_1.png" alt=""></p>
</li>
</ul>
<ul>
<li><p>设置SSL代理 </p>
<p>  点击Proxy-&gt;SSL Proxying Setting，勾选Enable SSL Proxying，然后点击Add输入要SSL代理的请求Host和Port，可以使用通配符来表示某一类请求。<br> <img src="https://github.com/dishibolei/img/raw/master/safe/http/charles_2.png" alt=""></p>
<p> 或者在对应的请求上右键选择Enable SSL Proxying，就会把这一个请求加入到上面的SSL代理列表中（类似于点击Add的效果）。 </p>
<p> <img src="https://github.com/dishibolei/img/raw/master/safe/http/charles_3.png" alt=""></p>
<p>  做完上述步骤后重新请求就能得到解密后的信息了。ps:抓取PC端的HTTPS包也类似，在Help-&gt;SSL Proxying中下载证书，双击安装证书，并选择始终信任即可。</p>
</li>
</ul>
<ul>
<li><p>在iPhone端设置HTTP代理</p>
<p>  在Mac上获取当前机器的IP地址：</p>
<p>  ifconfig en0:</p>
<p>  <img src="https://github.com/dishibolei/img/raw/master/safe/http/charles_4.jpg" alt=""></p>
<p> ch将iPhone连接到与电脑相同的WiFi，在iPhone设置中：无线局域网 -&gt; 已连接WiFi右边的Info详情图标 -&gt; HTTP代理 -&gt; 手动 -&gt; 设置HTTP代理：</p>
<p> <img src="https://github.com/dishibolei/img/raw/master/safe/http/charles_5.jpg" alt=""></p>
<p> 设置完成之后，打开Safari随便访问一个网页，初次设置代理的话，Charles会弹出一个iPhone请求代理的确认框，点击Allow即可。然后在Charles上就可以看到iPhone上的HTTP请求了。为了避免Mac上的请求过多影响对被代理iPhone上HTTP请求的查看和调试，可以在Charles取消Mac的代理：Menu -&gt; Proxy -&gt; 取消勾选Mac OS X Proxy 即可。</p>
</li>
</ul>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ol>
<li><p><a href="http://blog.csdn.net/gueter/archive/2007/03/08/1524447.aspx" target="_blank" rel="external">HTTP协议详解（真的很经典）</a></p>
</li>
<li><p><a href="https://github.com/mqttjs/MQTT.js" target="_blank" rel="external">MQTT_github</a></p>
</li>
<li><p><a href="http://www.cnblogs.com/zhao1949/p/5545064.html" target="_blank" rel="external">说说http协议中的编码和解码</a></p>
</li>
<li><p><a href="https://my.oschina.net/cnlw/blog/168466" target="_blank" rel="external">HTTP协议之multipart/form-data请求分析</a></p>
</li>
<li><p><a href="http://www.jianshu.com/p/1ec3fa1ec00f" target="_blank" rel="external">苹果文档翻译 iOS10 NSAppTransportSecurity</a></p>
</li>
<li><p><a href="http://www.jianshu.com/p/2bfe1110f3b5" target="_blank" rel="external">iOS中的HTTPS, 你知道多少?</a></p>
</li>
<li><p><a href="http://www.open-open.com/lib/view/open1411260089562.html" target="_blank" rel="external">阮一峰：图解SSL/TLS协议</a></p>
</li>
<li><p><a href="http://kb.cnblogs.com/page/197396/" target="_blank" rel="external">SSL与TLS的区别以及介绍</a></p>
</li>
<li><p><a href="http://www.2cto.com/article/201607/523509.html" target="_blank" rel="external">浅析HTTPS中间人攻击与证书校验</a></p>
</li>
<li><p><a href="http://www.cnblogs.com/LittleHann/p/3733469.html?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">SSL、TLS协议格式入门学习 - .Little Hann</a></p>
</li>
<li><p><a href="http://oncenote.com/2015/09/16/Security-2-HTTPS2/" target="_blank" rel="external">iOS安全系列之二：HTTPS进阶</a></p>
</li>
<li><p><a href="http://www.open-open.com/lib/view/open1461324289052.html" target="_blank" rel="external">HTTPS 理论详解与实践</a></p>
</li>
<li><p><a href="https://my.oschina.net/wayhk/blog/491958?p=1" target="_blank" rel="external">利用OpenSSL创建自签名的SSL证书</a></p>
</li>
<li><p><a href="http://blog.csdn.net/sdcxyz/article/details/47220129" target="_blank" rel="external">自签名证书和私有CA签名的证书的区别 创建自签名证书 创建私有CA 证书类型 证书扩展名</a></p>
</li>
<li><p><a href="https://www.zybuluo.com/qidiandasheng/note/713956" target="_blank" rel="external">深入解析HTTPS</a></p>
</li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/安全/" rel="tag"># 安全</a>
          
            <a href="/tags/HTTPS/" rel="tag"># HTTPS</a>
          
            <a href="/tags/SSL证书/" rel="tag"># SSL证书</a>
          
        </div>
      

      
        
      

      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODYyNy81MTk4"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="bolei" />
          <p class="site-author-name" itemprop="name">bolei</p>
           
              <p class="site-description motion-element" itemprop="description">专注于IOS客户端安全、性能、架构和react-native技术</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/dishibolei" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTP简介"><span class="nav-number">1.</span> <span class="nav-text">HTTP简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTPS简介"><span class="nav-number">2.</span> <span class="nav-text">HTTPS简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SSL-TLS简介"><span class="nav-number">2.1.</span> <span class="nav-text">SSL/TLS简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTPS原理"><span class="nav-number">2.2.</span> <span class="nav-text">HTTPS原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTPS加密流程"><span class="nav-number">2.2.1.</span> <span class="nav-text">HTTPS加密流程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#常用的网络传输攻击手段"><span class="nav-number">3.</span> <span class="nav-text">常用的网络传输攻击手段</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SSL证书"><span class="nav-number">4.</span> <span class="nav-text">SSL证书</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SSL证书是什么"><span class="nav-number">4.1.</span> <span class="nav-text">SSL证书是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SSL证书如何验证的"><span class="nav-number">4.2.</span> <span class="nav-text">SSL证书如何验证的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何验证CA根证书有效性"><span class="nav-number">4.3.</span> <span class="nav-text">如何验证CA根证书有效性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#中间人攻击"><span class="nav-number">4.4.</span> <span class="nav-text">中间人攻击</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#校验证书的姿势"><span class="nav-number">4.5.</span> <span class="nav-text">校验证书的姿势</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#证书强校验的坑"><span class="nav-number">4.6.</span> <span class="nav-text">证书强校验的坑</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#附录"><span class="nav-number">5.</span> <span class="nav-text">附录:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#如何生成自签名证书"><span class="nav-number">5.1.</span> <span class="nav-text">如何生成自签名证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MAC下使用Charles抓包"><span class="nav-number">5.2.</span> <span class="nav-text">MAC下使用Charles抓包</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考文献"><span class="nav-number">6.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bolei</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

</body>
</html>
