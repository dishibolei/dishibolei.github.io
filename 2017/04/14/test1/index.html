<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS开发,macOS开发," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="前言本篇讲述的AVAsset元数据(可以简单理解成 比如一个mp3音频格式的model信息. title:xxxx, art:刘德华, album:专辑 爱你一万年…. 等这些数据的来源). 当然这种意义上的字段信息 属于AVAsset的一个属性。AV Foundation通过AVAsset封装来处理各种音频的元数据, 比如从mp3文件中解析出来封面图(artwork)等。 本章的具体内容如下:">
<meta name="keywords" content="iOS开发,macOS开发">
<meta property="og:type" content="article">
<meta property="og:title" content="Learning AV Foundation(四)AVAsset元数据">
<meta property="og:url" content="https://dishibolei.github.io/2017/04/14/test1/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="前言本篇讲述的AVAsset元数据(可以简单理解成 比如一个mp3音频格式的model信息. title:xxxx, art:刘德华, album:专辑 爱你一万年…. 等这些数据的来源). 当然这种意义上的字段信息 属于AVAsset的一个属性。AV Foundation通过AVAsset封装来处理各种音频的元数据, 比如从mp3文件中解析出来封面图(artwork)等。 本章的具体内容如下:">
<meta property="og:image" content="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/MacHi%202017-04-14%2009-18-10.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/MacHi%202017-04-14%2011-44-16.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/atom.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/atom_inspector.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/quick_time_atom_structure.jpeg">
<meta property="og:image" content="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/quick_time_atom_structure_real.jpeg">
<meta property="og:updated_time" content="2017-05-11T10:02:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Learning AV Foundation(四)AVAsset元数据">
<meta name="twitter:description" content="前言本篇讲述的AVAsset元数据(可以简单理解成 比如一个mp3音频格式的model信息. title:xxxx, art:刘德华, album:专辑 爱你一万年…. 等这些数据的来源). 当然这种意义上的字段信息 属于AVAsset的一个属性。AV Foundation通过AVAsset封装来处理各种音频的元数据, 比如从mp3文件中解析出来封面图(artwork)等。 本章的具体内容如下:">
<meta name="twitter:image" content="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/MacHi%202017-04-14%2009-18-10.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dishibolei.github.io/2017/04/14/test1/"/>





  <title>Learning AV Foundation(四)AVAsset元数据 | Hexo</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">我的小博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://dishibolei.github.io/2017/04/14/test1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="bolei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Learning AV Foundation(四)AVAsset元数据</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-14T09:32:50+08:00">
                2017-04-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS开发/" itemprop="url" rel="index">
                    <span itemprop="name">iOS开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/MacHi%202017-04-14%2009-18-10.png" alt=""></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇讲述的<code>AVAsset</code>元数据(可以简单理解成 比如一个mp3音频格式的model信息. title:xxxx, art:刘德华, album:专辑 爱你一万年…. 等这些数据的来源). 当然这种意义上的字段信息 属于<code>AVAsset</code>的一个属性。<code>AV Foundation</code>通过<code>AVAsset</code>封装来处理各种音频的元数据, <strong>比如从mp3文件中解析出来封面图(artwork)</strong>等。 本章的具体内容如下:</p>
<h3 id="理解资源含义"><a href="#理解资源含义" class="headerlink" title="理解资源含义"></a><strong>理解资源含义</strong></h3><h3 id="创建资源"><a href="#创建资源" class="headerlink" title="创建资源"></a><strong>创建资源</strong></h3><ul>
<li>iOS Asset库</li>
<li>iOS iPod库</li>
<li>macOS iTunes库</li>
</ul>
<h3 id="异步载入"><a href="#异步载入" class="headerlink" title="异步载入"></a><strong>异步载入</strong></h3><h3 id="媒体元数据"><a href="#媒体元数据" class="headerlink" title="媒体元数据"></a><strong>媒体元数据</strong></h3><ul>
<li>元数据格式  <ol>
<li>QuickTime  </li>
<li>MPEG-4音频和视频(mp4)  </li>
<li>MP3  </li>
</ol>
</li>
</ul>
<h3 id="使用元数据"><a href="#使用元数据" class="headerlink" title="使用元数据"></a><strong>使用元数据</strong></h3><ul>
<li>查询元数据</li>
<li>使用<code>AVMetadataItem</code></li>
</ul>
<h3 id="创建MetaManager-Demo"><a href="#创建MetaManager-Demo" class="headerlink" title="创建MetaManager Demo"></a><strong>创建MetaManager Demo</strong></h3><ul>
<li>MediaItem(相当于Model)</li>
<li>MediaItem实现</li>
<li>数据转换器(model to AVMetadataItem || AVMetadataItem to mode)</li>
<li>DefaultMetadata默认转换</li>
<li>转换Artwork(唱片的封面或者专辑图那种)</li>
<li>转换注释</li>
<li>转换音轨数据(track)</li>
<li>转换唱片数据</li>
<li>转换风格数据(genre, eg: blue蓝调, classic古典,pop流行等126种..)</li>
<li>完成最终demo  </li>
</ul>
<h4 id="保存元数据"><a href="#保存元数据" class="headerlink" title="保存元数据"></a><strong>保存元数据</strong></h4><hr>
<h3 id="理解AVAsset资源含义"><a href="#理解AVAsset资源含义" class="headerlink" title="理解AVAsset资源含义"></a><strong>理解<code>AVAsset</code>资源含义</strong></h3><p><code>AVAsset</code>是一个不可变的抽象类,定义媒体资源混合呈现方式.里面包含音视频的<strong>曲目</strong>、<strong>格式</strong>、<strong>时长</strong>, 以及<strong>元数据NSData</strong>(二进制的bytes).</p>
<p><code>AVAsset</code>不用考虑媒体资源具有的两个范畴: </p>
<ul>
<li>提供对基本媒体格式的抽象层  </li>
<li>不用考虑处理因为不同格式获取内容方式不一样</li>
</ul>
<p>这意味着无论是处理<code>Quick Time</code>影片、<code>MPEG-4</code>视频还是<code>MP3</code>音频，框架提供统一的接口，我们只需要理解只有资源这个概念。这样做的目的是为了<strong>开发者在面对不同格式的内容时有一个统一的处理方法。不需要care多种编码器和容器格式因为细节不同而带来的困扰</strong>. 当然获取这些其余信息可以通过其它方式实现. <code>AVAsset</code>还隐藏了资源位置(GPS定位)信息,当处理一个媒体对象时，通过URL来初始化init. URL可以是Bundle里面 也可以是沙盒的本地文件系统URL.也可以从iPod库中取到的URL。还可以是远程服务器的音频流或视频流的URL。</p>
<p><code>AVAsset</code>属于低耦合组件方式的封装 让框架来处理那些繁重的工作, 我们就可以很方便的不用考虑文件位置的前提下获取或者载入媒体。由于不用care文件合适和文件位置等复杂的问题。<code>AVAsset</code>为开发者处理<code>timed media(时基媒体)</code>提供了一种简单统一的方式.</p>
<p><code>AVAsset</code>本身不是媒体资源. 可以把它理解成承载<code>timed media(时基媒体)</code>的容器类。它有很多描述自身元数据的媒体组成. <code>AVAssetTrack</code>才是我们真正存储媒体资源的统一媒体类型。并对每个资源建立相应的model.  <code>AVAssetTrack</code>最常见的形式就是 音频流和视频流, 但是他还可以用于表示诸如<strong>文本</strong>、<strong>副标题</strong>、<strong>隐藏字幕</strong>等媒体类型. 如下示意图理解<code>AVAsset</code> 和 <code>AVAssetTrack</code></p>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/MacHi%202017-04-14%2011-44-16.png" alt=""></p>
<p><em><strong><code>AVAsset.tracks</code></strong></em> 如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">AVAssetTrack</span> *&gt; *tracks;</div></pre></td></tr></table></figure>
<p> 资源曲目可通过tracks属性访问到. 该属性返回一个NSArray的数组,这个数组中的元素就是专辑包含的所有曲目. 此外，<code>AVAsset</code>还可以通过标识符、媒体类型或媒体特征等信息找到相应的曲目.这使得在未来更高级的处理中我们可以很容易获取一组需要的曲目</p>
<h4 id="创建资源-1"><a href="#创建资源-1" class="headerlink" title="创建资源"></a><strong>创建资源</strong></h4><p>当为一个现有的媒体资源创建<code>AVAsset</code>对象时, 可以通过URL对它的进行的初始化来实现. 一般来说是一个本地文件URL, 也可以是远程的资源URL</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">    <span class="built_in">NSURL</span> *assetURL = <span class="comment">//....</span></div><div class="line">    <span class="built_in">AVAsset</span> *asset = [<span class="built_in">AVAsset</span> assetWithURL: assetURL];</div><div class="line">```    </div><div class="line"></div><div class="line">`<span class="built_in">AVAsset</span>`是个抽象类, 它不能直接被实例化. 当使用`assetWithURL:`方法创建实例时,实际上是创建了`<span class="built_in">AVAsset</span>`的子类`<span class="built_in">AVURLAsset</span>` 有时候会直接使用这个类, 因为它允许通过传递选项字典来精细调整资源的创建方式, 举个例子,比如创建 用在音频或视频编辑场景中的资源, 可能希望传递一个选项(option)的字典来告诉程序提供更精确的时长和计时等信息 例如:</div><div class="line"></div><div class="line">``` objc</div><div class="line">    <span class="built_in">NSURL</span> *assetURL = <span class="comment">//....</span></div><div class="line">    <span class="built_in">NSDictionary</span> *options = @&#123;<span class="built_in">AVURLAssetPreferPreciseDurationAndTimingKey</span>:@YES&#125;;</div><div class="line">    <span class="built_in">AVAsset</span> *asset = [<span class="built_in">AVAsset</span> assetWithURL: assetURL];</div><div class="line">```  </div><div class="line">这里传递的是希望得到稍长一点的加载事件,来获取更精确的时长及时间信息.很多常见的位置是开发时大家想创建资源对象的地方. 在iOS设备上我们希望在用户的照片库中访问视频文件, 或者在iPod库中访问歌曲. 在Mac上 我们希望从用户的iTunes库中找到媒体项. 借助iOS和macOS中的这些辅助framework我们可以使用上边的媒体资源。下面介绍一下这些要用到的framework的例子</div><div class="line"></div><div class="line"><span class="meta">##### iOS Assets库</span></div><div class="line"></div><div class="line">在iOS上拍照或者通过前置和后置相机捕捉到的音视频,它们保存在用户的照片库中.iOS提供的Assets库框架可以实现从照片库中读写的功能, 下例从用户资源库中的视频创建一个<span class="built_in">AVAsset</span>:</div><div class="line"></div><div class="line">``` objc</div><div class="line">ALAssetsLibrary *library = [[ALAssetsLibrary alloc] init];</div><div class="line">    [library enumerateGroupsWithTypes:ALAssetsGroupSavedPhotos usingBlock:^(ALAssetsGroup *group, <span class="built_in">BOOL</span> *stop) &#123;</div><div class="line">        <span class="comment">//Filter down to only videos</span></div><div class="line">        [group setAssetsFilter:[ALAssetsFilter allVideos]];</div><div class="line">        </div><div class="line">        <span class="comment">//Grab the first video returned</span></div><div class="line">        [group enumerateAssetsAtIndexes:[<span class="built_in">NSIndexSet</span> indexSetWithIndex:<span class="number">0</span>] options:<span class="number">0</span> usingBlock:^(ALAsset *result, <span class="built_in">NSUInteger</span> index, <span class="built_in">BOOL</span> *stop) &#123;</div><div class="line">            <span class="keyword">if</span> (result) &#123;</div><div class="line">                <span class="keyword">id</span> representation = [result defaultRepresentation];</div><div class="line">                <span class="built_in">NSURL</span> *url = [representation url];</div><div class="line">                <span class="built_in">AVAsset</span> *asset = [<span class="built_in">AVAsset</span> assetWithURL:url];</div><div class="line">                <span class="comment">//创建 调用一些其它API</span></div><div class="line">            &#125;</div><div class="line">        &#125;];</div><div class="line">        </div><div class="line">    &#125; failureBlock:^(<span class="built_in">NSError</span> *error) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [error localizedDescription]);</div><div class="line">    &#125;];</div></pre></td></tr></table></figure>
<p>上面是如何获取保存在 相册中的视频资源(iOS10.10以后就废弃了上述方式) 获取出筛选结果的第一个视频, 库中的条目全部被建模为<code>ALAsset</code>对象, 为默认的呈现方式选用<code>ALAsset</code>类型返回一个<code>ALAssetRepresentation</code>对象,它提供了一个适用于创建<code>AVAset</code>的URL.</p>
<h5 id="iOS-iPod库"><a href="#iOS-iPod库" class="headerlink" title="iOS iPod库"></a>iOS iPod库</h5><p>我们获取媒体的一个常见位置就是用户的iPod库. <code>MediaPlayer</code> framework 框架提供了API, 用于在iPod库中查询和获取条目. 当找到想获取的item时, 可以得到一个存储的URL并使用这个得到的URL初始化一个资源, 如下例所示:  </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//艺术家</span></div><div class="line"><span class="built_in">MPMediaPropertyPredicate</span> *artistPredicate = [<span class="built_in">MPMediaPropertyPredicate</span> predicateWithValue:<span class="string">@"刘德华"</span> forProperty:<span class="built_in">MPMediaItemPropertyArtist</span>];</div><div class="line"><span class="comment">//专辑</span></div><div class="line"><span class="built_in">MPMediaPropertyPredicate</span> *albumPredicate = [<span class="built_in">MPMediaPropertyPredicate</span> predicateWithValue:<span class="string">@"真永远"</span> forProperty:<span class="built_in">MPMediaItemPropertyAlbumTitle</span>];</div><div class="line"><span class="comment">//歌曲名称</span></div><div class="line"><span class="built_in">MPMediaPropertyPredicate</span> *songPredicate = [<span class="built_in">MPMediaPropertyPredicate</span> predicateWithValue:<span class="string">@"爱你一万年"</span> forProperty:<span class="built_in">MPMediaItemPropertyTitle</span>];</div><div class="line"><span class="comment">//查询</span></div><div class="line"><span class="built_in">MPMediaQuery</span> *query = [[<span class="built_in">MPMediaQuery</span> alloc] init];</div><div class="line">[query addFilterPredicate:artistPredicate];</div><div class="line">[query addFilterPredicate:albumPredicate];</div><div class="line">[query addFilterPredicate:songPredicate];</div><div class="line"></div><div class="line"><span class="built_in">NSArray</span> *result = [query items];</div><div class="line"><span class="keyword">if</span> (result.count &gt; <span class="number">0</span>) &#123;</div><div class="line">    <span class="built_in">MPMediaItem</span> *item = result[<span class="number">0</span>];</div><div class="line">    <span class="built_in">NSURL</span> *assetURL = [item valueForProperty:<span class="built_in">MPMediaItemPropertyAssetURL</span>];</div><div class="line">    <span class="built_in">AVAsset</span> *asset = [<span class="built_in">AVAsset</span> assetWithURL:assetURL];</div><div class="line">    <span class="comment">// Asset 信息</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>MediaPlayer</code>framework提供了一个为<code>MPMediaPropertyPredicate</code>的类,用户帮助用户在iPod库中查找到具体内容所用的查询语句<br>上边举例一个例子: 在<code>刘德华</code>的<code>真永远</code>(真永远专辑)  唱片中查找<code>爱你一万年</code>这首歌, 执行完查询 会返回这个媒体 条目的资源URL属性(<code>MPMediaItemPropertyAssetURL</code>). 并使用这个属性创建<code>AVAsset</code></p>
<h5 id="macOS-iTunes库"><a href="#macOS-iTunes库" class="headerlink" title="macOS iTunes库"></a>macOS iTunes库</h5><p>在 macOS(以前叫 OS X)上, iTunes是用户的媒体资源中心. 要识别这个库中的资源, 我们通常要对iTunes音乐目录中的iTunes Music Library.xml 文件进行解析, 从而得到相关数据. 不过在 Mac OS X 10.8山狮之后 有了比较简单的方法–<code>iTunesLibrary</code>framework.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ITLibrary *library = [ITLibrary libraryWithAPIVersion:<span class="string">@"1.0"</span> error:<span class="literal">nil</span>];</div><div class="line">    <span class="built_in">NSArray</span> *items = library.allMediaItems;</div><div class="line">    </div><div class="line">    <span class="built_in">NSString</span> *query = <span class="string">@"artist.name == '刘德华'"</span></div><div class="line">                      <span class="string">"album.title == '真永远'"</span></div><div class="line">                      <span class="string">"title == '爱你一万年'"</span>;</div><div class="line">    <span class="built_in">NSPredicate</span> *predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:query];</div><div class="line">    </div><div class="line">    <span class="built_in">NSArray</span> *songs = [items filteredArrayUsingPredicate:predicate];</div><div class="line">    <span class="keyword">if</span> (songs.count &gt; <span class="number">0</span>) &#123;</div><div class="line">        ITLibMediaItem *item = songs[<span class="number">0</span>];</div><div class="line">        <span class="built_in">AVAsset</span> *asset = [<span class="built_in">AVAsset</span> assetWithURL:item.location];</div><div class="line">        <span class="comment">// asset info</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>iTunesLibrary</code>框架并没有像MediaPlayer框架那样给出具体的查询API. 不过开发者可使用标准的Cocoa NSPredicate(谓词)类来构建一个复杂的查询,当筛出需要的media item集合后，可使用<code>ITLibMediaItem</code>的<code>location</code>属性得到一个URL并创建<code>AVAsset</code>.</p>
<h4 id="异步载入-1"><a href="#异步载入-1" class="headerlink" title="异步载入"></a>异步载入</h4><p><code>AVAsset</code>具有多种有用的方法和属性, 可以提供有关资源的信息, 比如时长、创建日期、元数据等.<br><code>AVAsset</code>还包含一些用于获取和使用曲目集合的方法. 不过有一点很重要, 就是当创建时资源就是对基础文件的处理, <code>AVAsset</code> 采用一种lazy load的加载方式, 提升了快速创建资源和立即载入的速度.<br><strong><em>注意<code>AVAsset</code>的属性访问是同步的,如果正在请求的属性没有预先载入,程序就会阻塞,直到它做出响应为止</em></strong>这个搞法不是很好,eg: avasset.duration 可能是个比较耗时的操作,如果使用MP3文件时没有在头文件中设置<code>TLEN</code>标签,这个标签用于定义duration值,则整个音频曲目都需要进行解析来准确的知道它的duration, 如果在主线程做这样的访问操作就会阻塞主线程,直到相关操作完成为止, APP可能会出现卡顿,导致系统监视器介入,并终止APP运行,如果解决这种问题,我们应该使用异步的 方式来查询资源属性.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">AVKeyValueStatus</span>)statusOfValueForKey:(<span class="built_in">NSString</span> *)key error:(<span class="built_in">NSError</span> * _Nullable *)outError;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)loadValuesAsynchronouslyForKeys:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)keys completionHandler:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))handler;</div></pre></td></tr></table></figure>
<p>可以使用statusOfValueForKey:error:方法查询一个给定的属性状态,返回一个<code>AVKeyValueStatus</code>的枚举值</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="built_in">AVKeyValueStatus</span> : <span class="built_in">NSInteger</span> &#123;</div><div class="line">    <span class="built_in">AVKeyValueStatusUnknown</span>,</div><div class="line">    <span class="built_in">AVKeyValueStatusLoading</span>,</div><div class="line">    <span class="built_in">AVKeyValueStatusLoaded</span>,</div><div class="line">    <span class="built_in">AVKeyValueStatusFailed</span>,</div><div class="line">    <span class="built_in">AVKeyValueStatusCancelled</span></div><div class="line">&#125; <span class="built_in">AVKeyValueStatus</span>;</div></pre></td></tr></table></figure>
<p>用于表示当前所请求的属性的状态, 如果状态不是<code>AVKeyValueStatusLoaded</code>说明此时这个属性可能导致程序卡顿,要异步载入一个给定的属性loadValuesAsynchronouslyForKeys:completionHandler:方法,参数keys 是一个或多个<code>资源属性名</code>的数组和一个callback,当资源处于回应状态时,就会调用这个<code>completionHandler</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSURL</span> *assetURL = [[<span class="built_in">NSBundle</span> mainBundle] URLForResource:<span class="string">@"384551_1438267683"</span> withExtension:<span class="string">@"mov"</span>];</div><div class="line">   <span class="built_in">AVAsset</span> *asset = [<span class="built_in">AVAsset</span> assetWithURL:assetURL];</div><div class="line">   <span class="comment">//异步加在 tracks property</span></div><div class="line">   <span class="built_in">NSArray</span> *keys = @[<span class="string">@"tracks"</span>];</div><div class="line">   [asset loadValuesAsynchronouslyForKeys:keys completionHandler:^&#123;</div><div class="line">       <span class="comment">//查询tracks的属性状态</span></div><div class="line">       <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line">       <span class="built_in">AVKeyValueStatus</span> status = [asset statusOfValueForKey:<span class="string">@"tracks"</span> error:&amp;error];</div><div class="line">       <span class="keyword">switch</span> (status) &#123;</div><div class="line">           <span class="keyword">case</span> <span class="built_in">AVKeyValueStatusLoaded</span>:</div><div class="line">               <span class="comment">//继续处理后续逻辑</span></div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> <span class="built_in">AVKeyValueStatusFailed</span>:</div><div class="line">               <span class="comment">//有error</span></div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> <span class="built_in">AVKeyValueStatusCancelled</span>:</div><div class="line">               <span class="comment">// 处理意外取消等情况的逻辑</span></div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           </div><div class="line">           <span class="keyword">default</span>:</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;];</div></pre></td></tr></table></figure>
<p>这里用bundle中的<code>QuickTime</code>电影创建一个AVAsset, 并异步载入该对象的<code>tracks</code>属性.在<code>completionHandler</code> block中,我们希望通过调用资源的statusOfValueForKey:error:方法来拿出请求属性的状态,NSError用于判断资源包含错误信息. <em><em>注意:<code>completionHandler:</code>block可能在任意一个队列中调用,在对UI界面做出相应更新之前,必须先回到主线程队列,否则必被坑！！！</em></em></p>
<blockquote>
<p><em><em>注意:上面的demo载入了一个tracks属性,其实可以在一个吊用中请求多个属性,如果请求多个属性的时候需要注意以下两点:</em></em><br>(1) 每次调用 <code>loadValuesAsynchronouslyForKeys:completionHandler:</code>方法时只会调用一次<code>completionHandler</code>block, 调用这个callback的次数不是根据传递给这个方法的key个数决定的.<br>(2) 需要为每个请求的属性调用<code>statusOfValueForKey:error:</code>,不能假设所有属性都返回相同的状态值.</p>
</blockquote>
<h3 id="使用元数据-1"><a href="#使用元数据-1" class="headerlink" title="使用元数据"></a><strong>使用元数据</strong></h3><p>当创建一个媒体应用程序时,了解该媒体的组织格式非常重要, 简单的展示一堆文件名也许在文件不多的时候还能接受, 如果大规模批量的文件需要展示就比较蛋疼了, 我们真正需要的是 <em>找到一种方法对媒体进行描述,当用户可以方便的找到、识别和组织这些媒体.</em> 我们所使用的<code>AV Foundation</code>中的主要媒体格式(<em>.mp4、</em>.mp3、<em>.mov、</em>.mkv…..)都可以嵌入描述其内容的元数据.因为各种媒体格式的描述不尽相同,要搞一套通用的策略去解析各种媒体的格式文件,这要求我们对底层技术有一些了解.不过<code>AV Foundation</code>让这些变得简单,因为它使开发者不需要考虑大多数特定格式的细节; 在处理媒体元数据方面, AV Foundation`提供了一套统一的方法.</p>
<h4 id="元数据格式"><a href="#元数据格式" class="headerlink" title="元数据格式"></a>元数据格式</h4><p>虽然存在多种格式的媒体资源,但是我们在Apple环境下遇到的媒体类型主要有4种, 分别是:<code>QuickTime(mov)</code>、<code>MPEG-4 video(mp4和m4v)</code>、<code>MPEG-4 audio(m4a)</code>和<code>MPEG-Layer Ⅲ audio(mp3)</code>. 虽然<code>AV Foundation</code>处理这些文件中嵌入的元数据时都使用一个接口, 但是理解这些不同类型资源的元数据如何存储及存储位置仍然很有价值. 这里只做概述, 但是如果深入研究这些都是必学的基础.</p>
<ol>
<li><p>QuickTime<br> <code>QuickTime</code>是苹果自己开发的一种跨平台媒体架构, 其中一部分是Quick File Format规范, 定义了 .mov文件的内部结构.<code>QuickTime</code>文件由一种称为<code>atom</code>的数据结构组成. 一般规则是这样的:<br> 一个<code>atom</code>包含了描述媒体资源的某一方面的数据, 或者嵌套包含其它<code>atom</code>,但不能两者都包含.有时候苹果自己的方法实现可能会违背这一规则.<code>atom</code>以一种复杂的树状结构组合在一起, 详细的对布局、音频样本格式、视频帧信息乃至需要呈现的元数据信息(作者,版权等)做了描述.   </p>
<p> <img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/atom.jpg" alt=""><br> <em>为了能记住<code>atom</code>我把它戏称为<code>阿童木</code>哈哈-跟阿童木压根没啥关系</em>.  </p>
<p> 了解<code>QuickTime</code>的一个好办法是用十六进制编辑器中打开一个.mov格式的文件.(常见的十六进制编辑器有Hex Fiend或Synalyze It! Pro).典型的十六进制工具会将一个真实的<code>QuickTime</code>文件的数据显示出来,但其中的结构和<code>atom</code>间的关系不是很直观能理解,推荐苹果有一个<code>Atom Inspector</code>工具.这个工具将atom结构以<code>NSOutlineView</code>(树形UI控件类似UITableView)方式显示.所以<code>atom</code>的树形瓜西会很清晰的看到,这个工具还提供一个小型的十六进制查看器,可以从中查看到<strong>实际字节布局</strong>.</p>
<p> <img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/atom_inspector.png" alt=""></p>
<p> 下载地址:<a href="http://adcdownload.apple.com/QuickTime/atom_inspector/atom_inspector.dmg" target="_blank" rel="external">Atom Inspector 猛击这里</a>  貌似需要登录开发者帐号<br> 下载中心:<a href="https://developer.apple.com/download/more/" target="_blank" rel="external">苹果官方软件下载中心</a>  貌似需要登录开发者帐号 </p>
<p> 下图就是atom格式<br> <img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/quick_time_atom_structure.jpeg" alt=""><br> <em>atom格式</em></p>
<p> <strong><code>QuickTime</code>文件最少包含三个高级的<code>atom</code></strong></p>
<ul>
<li><strong>用于描述文件类型和兼容类型的<code>fypy</code></strong></li>
<li><strong>包含实际音频和视频媒体的<code>mdat</code></strong></li>
<li><p><strong>moov atom(moo-vee) 媒体资源的所有细节做了完整描述包括原始的二进制数据</strong></p>
<p>下图是我实际测试一个mov文件的atom<br><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/Learning-AV-Foundation-AVAsset/quick_time_atom_structure_real.jpeg" alt=""><br><em>实测</em></p>
</li>
</ul>
</li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS开发/" rel="tag"># iOS开发</a>
          
            <a href="/tags/macOS开发/" rel="tag"># macOS开发</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/05/08/我的第一篇博文/" rel="prev" title="我的第一篇博文">
                我的第一篇博文 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="bolei" />
          <p class="site-author-name" itemprop="name">bolei</p>
           
              <p class="site-description motion-element" itemprop="description">专注于IOS客户端安全、性能、架构和react-native技术</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/dishibolei" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#理解资源含义"><span class="nav-number">1.0.1.</span> <span class="nav-text">理解资源含义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建资源"><span class="nav-number">1.0.2.</span> <span class="nav-text">创建资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步载入"><span class="nav-number">1.0.3.</span> <span class="nav-text">异步载入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#媒体元数据"><span class="nav-number">1.0.4.</span> <span class="nav-text">媒体元数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用元数据"><span class="nav-number">1.0.5.</span> <span class="nav-text">使用元数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建MetaManager-Demo"><span class="nav-number">1.0.6.</span> <span class="nav-text">创建MetaManager Demo</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#保存元数据"><span class="nav-number">1.0.6.1.</span> <span class="nav-text">保存元数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#理解AVAsset资源含义"><span class="nav-number">1.0.7.</span> <span class="nav-text">理解AVAsset资源含义</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建资源-1"><span class="nav-number">1.0.7.1.</span> <span class="nav-text">创建资源</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#iOS-iPod库"><span class="nav-number">1.0.7.1.1.</span> <span class="nav-text">iOS iPod库</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#macOS-iTunes库"><span class="nav-number">1.0.7.1.2.</span> <span class="nav-text">macOS iTunes库</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#异步载入-1"><span class="nav-number">1.0.7.2.</span> <span class="nav-text">异步载入</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用元数据-1"><span class="nav-number">1.0.8.</span> <span class="nav-text">使用元数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#元数据格式"><span class="nav-number">1.0.8.1.</span> <span class="nav-text">元数据格式</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bolei</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
